<!DOCTYPE html>
<html>
  <head>
    <title>BronnenFlow</title>
    <meta charset='utf-8' />
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <style>
    .node {
      stroke-width: 3px;
    }
    .link {
      stroke-width: 3;
      stroke-opacity: .3;
    }
    </style>
  </head>
  <body>
    
    <!--Add buttons to initiate auth sequence and sign out-->
    <button id="authorize-button" style="display: none;">Authorize</button>
    <button id="signout-button" style="display: none;">Sign Out</button>

    <pre id="content"></pre>

    <script type="text/javascript">

var width = 800,
    height = 600;

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

var ppl = [];
var links = [];

var color = d3.scaleOrdinal(d3.schemeCategory20);

var simulation = d3.forceSimulation()
    .force("link", d3.forceLink().id(function(d) { return d.id; }))
    .force("charge", d3.forceManyBody())
    .force("center", d3.forceCenter(width / 2, height / 2));


      // Client ID and API key from the Developer Console
      var CLIENT_ID = '1072441761062-7hnjkvs9ttaduam2jo04un6v14a3h995.apps.googleusercontent.com';

      // Array of API discovery doc URLs for APIs used by the quickstart
      var DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];

      // Authorization scopes required by the API; multiple scopes can be
      // included, separated by spaces.
      var SCOPES = "https://www.googleapis.com/auth/spreadsheets.readonly";

      var authorizeButton = document.getElementById('authorize-button');
      var signoutButton = document.getElementById('signout-button');

      /**
       *  On load, called to load the auth2 library and API client library.
       */
      function handleClientLoad() {
        gapi.load('client:auth2', initClient);
      }

      /**
       *  Initializes the API client library and sets up sign-in state
       *  listeners.
       */
      function initClient() {
        gapi.client.init({
          discoveryDocs: DISCOVERY_DOCS,
          clientId: CLIENT_ID,
          scope: SCOPES
        }).then(function () {
          // Listen for sign-in state changes.
          gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);

          // Handle the initial sign-in state.
          updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
          authorizeButton.onclick = handleAuthClick;
          signoutButton.onclick = handleSignoutClick;
        });
      }

      /**
       *  Called when the signed in status changes, to update the UI
       *  appropriately. After a sign-in, the API is called.
       */
      function updateSigninStatus(isSignedIn) {
        if (isSignedIn) {
          authorizeButton.style.display = 'none';
          signoutButton.style.display = 'block';
          getData();
          
        } else {
          authorizeButton.style.display = 'block';
          signoutButton.style.display = 'none';
        }
      }

      /**
       *  Sign in the user upon button click.
       */
      function handleAuthClick(event) {
        gapi.auth2.getAuthInstance().signIn();
      }

      /**
       *  Sign out the user upon button click.
       */
      function handleSignoutClick(event) {
        gapi.auth2.getAuthInstance().signOut();
      }

      function getData() {
        gapi.client.sheets.spreadsheets.values.batchGet({
          spreadsheetId: '1egducbYEw4kLe0frT4O9TRN4qSehzWu5RFHVTAsO8I8',
          ranges: ['Data!A2:J', 'Sleutel personen!A2:J']
        }).then(function(response) {
          var brieven = response.result.valueRanges[0];
          var personen = response.result.valueRanges[1];
          var brieflinks = [];
          if (brieven.values.length > 0) {
            for (i = 0; i < brieven.values.length; i++) {
              var row = brieven.values[i];
              // Print columns A and E, which correspond to indices 0 and 4.
              brieflinks.push({sourceID:row[1],destID:row[5]})
            }
          }
          if (personen.values.length > 0) {
            for (i = 0; i < personen.values.length; i++) {
              var row = personen.values[i];
              // Print columns A and E, which correspond to indices 0 and 4.
              if(row[1]!==undefined) ppl.push({ID:row[0],name:row[1]})
            }
          }

var links = parseDebt([brieflinks],ppl)

  var link = svg.append("g")
      .attr("class", "links")
    .selectAll("line")
    .data(links)
    .enter().append("line")
      .attr("stroke-width", 1)

      .style("stroke", function(d){return d.color});


var node = svg.append("g")
      .attr("class", "nodes")
    .selectAll("circle")
    .data(ppl)
    .enter().append("circle")
      .attr("r", 5)
      .attr("fill",'red')
      

  node.append("title")
      .text(function(d) { return d.name; });



  simulation
      .nodes(ppl)
      .on("tick", ticked);


  simulation.force("link")
      .links(links);


function ticked() {
    link
        .attr("x1", function(d) { return d.source.x; })
        .attr("y1", function(d) { return d.source.y; })
        .attr("x2", function(d) { return d.target.x; })
        .attr("y2", function(d) { return d.target.y; });

    node
        .attr("cx", function(d) { return d.x; })
        .attr("cy", function(d) { return d.y; });
  }

        }, function(response) {
         
        });
      }


function parseDebt(files,ppl) {
  var lnks = [];
  files.forEach(function(file,idx){
    file.forEach(function(d){
      var sourceNode = ppl.filter(function(n) {
          return n.ID === d.sourceID;
      })[0],
      targetNode = ppl.filter(function(n) {
          return n.ID === d.destID;
      })[0];
      sourceNode.linkCount++;
      targetNode.linkCount++;
      
      lnks.push({
          source: sourceNode,
          target: targetNode,
          color: '#000000'
      });
    })
  })
  return lnks;
}

 
    </script>

    <script async defer src="https://apis.google.com/js/api.js"
      onload="this.onload=function(){};handleClientLoad()"
      onreadystatechange="if (this.readyState === 'complete') this.onload()">
    </script>
  </body>
</html>